<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{dashBoard}" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Product Chart</title>
<!-- Thêm link đến thư viện Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
	<div layout:fragment="content">
		<form method="GET">
			<div class="mb-3 col-2">
				<label for="secondProduct" class="col-form-label">Select
					SecondProduct:</label> <select class="form-select"
					aria-label="Default select example" id="secondProduct"
					onchange="redirectToSecondProduct()">
					<option selected disabled>Choose a product</option>
					<option th:each="product : ${productDetails}"
						th:value="${product.id}" th:text="${product.title}"
						th:selected="${product.id == secondProductId}">Product
						Name</option>
				</select>
			</div>

			<div class="row mb-3">
				<label for="startDate" class="col-sm-2 col-form-label">Start
					Date:</label>
				<div class="col-sm-4">
					<input type="date" class="form-control" id="startDate"
						name="startDate"
						th:value="${startDate != null ? #dates.format(startDate, 'yyyy-MM-dd') : ''}">
				</div>
				<label for="endDate" class="col-sm-2 col-form-label">End
					Date:</label>
				<div class="col-sm-4">
					<input type="date" class="form-control" id="endDate" name="endDate"
						th:value="${endDate != null ? #dates.format(endDate, 'yyyy-MM-dd') : ''}">
				</div>
			</div>
			<input type="hidden" name="productDetailId"
				th:value="${productDetailId}">
			<div th:if="${secondProductId != null}">
				<input type="hidden" name="secondProductId"
					th:value="${secondProductId}">
			</div>

			<div class="row">
				<div class="col-sm-10 offset-sm-2">
					<button type="submit" class="btn btn-primary">Update Chart</button>
				</div>
			</div>

		</form>

		<!-- Canvas element for the chart -->
		<canvas id="revenueChart" width="400" height="200"></canvas>


		<!-- Script to render the chart -->
		<script th:inline="javascript">
    /*<![CDATA[*/
    var revenueData = /*[[${revenueData}]]*/ [];
    var secondData = /*[[${secondData}]]*/ [];

    var labels = [], revenue = [], secondRevenue = [];

    // Lấy giá trị ngày bắt đầu và kết thúc
    var startDateElem = document.getElementById("startDate");
    var endDateElem = document.getElementById("endDate");
    
    var startDate = startDateElem ? startDateElem.value : null;
    var endDate = endDateElem ? endDateElem.value : null;

    if (startDate && endDate) {
        // Tính toán số ngày giữa startDate và endDate
        var diffInDays = Math.round((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;

        if (diffInDays < 90) {
            var allDates = [];
            for (var date = new Date(startDate); date <= new Date(endDate); date.setDate(date.getDate() + 1)) {
                allDates.push(new Date(date));
            }
            labels = allDates.map(date => date.toISOString().slice(0, 10));

            // Tạo dữ liệu doanh thu cho biểu đồ thứ nhất
            revenue = allDates.map(date => {
                if (revenueData && revenueData.length > 0) {
                    var item = revenueData.find(item => item.orderDate === date.toISOString().slice(0, 10));
                    return item ? item.revenue : 0;
                } else {
                    return 0;
                }
            });

            secondRevenue = allDates.map(date => {
                if (secondData && secondData.length > 0) {
                    var item = secondData.find(item => item.orderDate === date.toISOString().slice(0, 10));
                    return item ? item.revenue : 0;
                } else {
                    return 0;
                }
            });
        } else {
            labels = revenueData.length > 0 ? revenueData.map(item => item.orderDate) : secondData.map(item => item.orderDate);
            revenue = revenueData.length > 0 ? revenueData.map(item => item.revenue) : labels.map(() => 0);

            secondRevenue = secondData.length > 0 ? secondData.map(item => {
                var secondItem = secondData.find(secondItem => secondItem.orderDate === item.orderDate);
                return secondItem ? secondItem.revenue : 0;
            }) : labels.map(() => 0);
        }
    } else {
        // Nếu không có startDate và endDate, chỉ sử dụng dữ liệu hiện có
        if (revenueData && revenueData.length > 0) {
            labels = revenueData.map(item => item.orderDate);
            revenue = revenueData.map(item => item.revenue);
        }

        if (secondData && secondData.length > 0) {
            labels = secondData.length > labels.length ? secondData.map(item => item.orderDate) : labels;
            secondRevenue = secondData.map(item => item.revenue);
        }
    }

    var ctx = document.getElementById('revenueChart').getContext('2d');
    var datasets = [{
        label: 'Revenue (Product 1)',
        data: revenue,
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 3,
        tension: 0.4
    }];

    if (secondRevenue.length > 0) {
        datasets.push({
            label: 'Revenue (Product 2)',
            data: secondRevenue,
            backgroundColor: 'rgba(192, 75, 192, 0.2)',
            borderColor: 'rgba(192, 75, 192, 1)',
            borderWidth: 3,
            tension: 0.4
        });
    }

    var revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    /*]]>*/
</script>




		<script>
    function redirectToSecondProduct() {
        var productId = document.getElementById("secondProduct").value;
        var currentUrl = window.location.href;
        var separator = currentUrl.indexOf('?') !== -1 ? '&' : '?'; 
        
        if (currentUrl.indexOf('secondProductId') !== -1) {
            var newUrl = currentUrl.replace(/([&?]secondProductId=)[^&]+/, '$1' + productId);
        } else {
            var newUrl = currentUrl + separator + "secondProductId=" + productId;
        }
        
        window.location.href = newUrl;
    }
</script>



	</div>
</body>
</html>